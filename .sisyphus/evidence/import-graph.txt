================================================================================
LILYA CORE MODULE IMPORT DEPENDENCY GRAPH
================================================================================
Generated: 2026-02-16
Modules analyzed: lilya/routing.py, lilya/apps.py, lilya/responses.py, lilya/dependencies.py

================================================================================
1. MODULE: lilya/routing.py (2773 lines)
================================================================================

--- STDLIB IMPORTS ---
from __future__ import annotations
import functools
import inspect
import re
import traceback
from collections.abc import Awaitable, Callable, Mapping, Sequence
from contextlib import nullcontext
from typing import Annotated, Any, ClassVar, TypeVar

--- THIRD-PARTY IMPORTS ---
(None detected in first 100 lines)

--- INTERNAL LILYA IMPORTS ---
from lilya import status
from lilya._internal._events import AsyncLifespan, handle_lifespan_events
from lilya._internal._middleware import wrap_middleware
from lilya._internal._module_loading import import_string
from lilya._internal._path import clean_path, compile_path, get_route_path, parse_path, replace_params
from lilya._internal._permissions import wrap_permission
from lilya._internal._responses import BaseHandler
from lilya._internal._urls import include
from lilya.compat import is_async_callable
from lilya.concurrency import run_in_threadpool
from lilya.conf import _monkay
from lilya.conf.global_settings import Settings
from lilya.contrib.documentation import Doc
from lilya.datastructures import URL, Header, ScopeHandler, SendReceiveSniffer, URLPath
from lilya.dependencies import wrap_dependency  *** CROSS-IMPORT: dependencies ***
from lilya.enums import EventType, HTTPMethod, Match, ScopeType
from lilya.exceptions import ContinueRouting, HTTPException, ImproperlyConfigured
from lilya.lifecycle import get_hooks as _lifecycle_get_hooks
from lilya.middleware.base import DefineMiddleware
from lilya.permissions.base import DefinePermission
from lilya.requests import Request
from lilya.responses import PlainText, RedirectResponse, Response  *** CROSS-IMPORT: responses ***
from lilya.types import ASGIApp, Dependencies, ExceptionHandler, Lifespan, Receive, Scope, Send
from lilya.websockets import WebSocket, WebSocketClose

--- CROSS-IMPORTS FROM CORE MODULES ---
- lilya.dependencies → wrap_dependency
- lilya.responses → PlainText, RedirectResponse, Response

--- EXTERNAL CONSUMERS (38 matches in 17 files) ---
Files that import from lilya.routing:
1. lilya/background.py (2 imports)
2. lilya/_internal/_responses.py (1 import)
3. lilya/introspection/__builder.py (1 import)
4. lilya/conf/global_settings.py (9 imports)
5. lilya/context.py (1 import)
6. lilya/routing.py (1 self-import in docstring)
7. lilya/_internal/_events.py (1 import)
8. lilya/_internal/_connection.py (1 import)
9. lilya/_internal/_urls.py (1 import)
10. lilya/_internal/_templates/app_template/{{ api_version }}/urls.py-tpl (1 import)
11. lilya/apps.py (11 imports) *** CROSS-CONSUMER: apps imports routing ***
12. lilya/_internal/_templates/project_template/project_name/main.py-tpl (1 import)
13. lilya/_internal/_templates/project_template/project_name/urls.py-tpl (2 imports)
14. lilya/_internal/_templates/project_template_simple/project_name/app.py-tpl (1 import)
15. lilya/_internal/_templates/project_template_edgy/project_name/main.py-tpl (1 import)
16. lilya/_internal/_templates/project_template_edgy/project_name/urls.py-tpl (2 imports)
17. lilya/cli/directives/operations/show_urls.py (2 imports)

================================================================================
2. MODULE: lilya/apps.py (1521 lines)
================================================================================

--- STDLIB IMPORTS ---
from __future__ import annotations
from collections.abc import Awaitable, Callable, Mapping, Sequence
from inspect import isawaitable
from typing import Annotated, Any, ClassVar, ParamSpec, cast

--- THIRD-PARTY IMPORTS ---
(None detected in first 100 lines)

--- INTERNAL LILYA IMPORTS ---
from lilya import status
from lilya._internal._connection import Connection
from lilya._internal._middleware import wrap_middleware
from lilya._internal._module_loading import import_string
from lilya._internal._permissions import wrap_permission
from lilya._utils import is_class_and_subclass
from lilya.conf import _monkay, settings as lilya_settings
from lilya.conf.exceptions import FieldException
from lilya.conf.global_settings import Settings
from lilya.context import _G_ACTIVE, G, g_context
from lilya.contrib.documentation import Doc
from lilya.datastructures import State, URLPath
from lilya.dependencies import wrap_dependency  *** CROSS-IMPORT: dependencies ***
from lilya.exceptions import HTTPException
from lilya.introspection import ApplicationGraph
from lilya.introspection.__builder import GraphBuilder
from lilya.lifecycle import get_hooks as _lifecycle_get_hooks
from lilya.logging import LoggingConfig, setup_logging
from lilya.middleware.base import DefineMiddleware
from lilya.middleware.exceptions import ExceptionMiddleware
from lilya.middleware.lilya_exception import LilyaExceptionMiddleware
from lilya.middleware.server_error import ServerErrorMiddleware
from lilya.permissions.base import DefinePermission
from lilya.protocols.middleware import MiddlewareProtocol
from lilya.protocols.permissions import PermissionProtocol
from lilya.requests import Request
from lilya.responses import PlainText, Response  *** CROSS-IMPORT: responses ***
from lilya.routing import BasePath, Include, Path, Router, RoutingMethodsMixin  *** CROSS-IMPORT: routing ***
from lilya.serializers import SerializerConfig, setup_serializer
from lilya.types import ApplicationType, ASGIApp, CallableDecorator, Dependencies, ExceptionHandler, Lifespan, Receive, Scope, Send
from lilya.websockets import WebSocket

--- CROSS-IMPORTS FROM CORE MODULES ---
- lilya.dependencies → wrap_dependency
- lilya.responses → PlainText, Response
- lilya.routing → BasePath, Include, Path, Router, RoutingMethodsMixin

--- EXTERNAL CONSUMERS (41 matches in 17 files) ---
Files that import from lilya.apps:
1. lilya/background.py (2 imports)
2. lilya/introspection/__builder.py (2 imports)
3. lilya/conf/global_settings.py (7 imports)
4. lilya/conf/__init__.py (1 import)
5. lilya/apps.py (16 self-imports in docstrings)
6. lilya/cli/directives/operations/show_urls.py (1 import)
7. lilya/cli/env.py (1 import)
8. lilya/_internal/_connection.py (1 import)
9. lilya/middleware/wsgi.py (1 import)
10. lilya/logging.py (1 import)
11. lilya/context.py (1 import)
12. lilya/testclient/helpers.py (1 import)
13. lilya/serializers.py (1 import)
14. lilya/contrib/mail/dependencies.py (1 import)
15. lilya/_internal/_templates/project_template_simple/project_name/app.py-tpl (1 import)
16. lilya/_internal/_templates/project_template_edgy/project_name/main.py-tpl (1 import)
17. lilya/_internal/_templates/project_template/project_name/main.py-tpl (1 import)

================================================================================
3. MODULE: lilya/responses.py (1586 lines)
================================================================================

--- STDLIB IMPORTS ---
from __future__ import annotations
import contextlib
import functools
import http.cookies
import inspect
import os
import stat
import time
import typing
import warnings
from collections.abc import AsyncIterable, Awaitable, Callable, Coroutine, Generator, Iterable, Mapping, Sequence
from contextvars import ContextVar
from datetime import datetime
from email.utils import format_datetime, formatdate
from inspect import isawaitable, isclass
from io import FileIO
from mimetypes import guess_type
from typing import IO, Any, Literal, NoReturn, cast
from urllib.parse import quote

--- THIRD-PARTY IMPORTS ---
import anyio

--- INTERNAL LILYA IMPORTS ---
from lilya import status
from lilya._internal._helpers import HeaderHelper
from lilya.background import Task
from lilya.compat import md5_hexdigest
from lilya.concurrency import iterate_in_threadpool
from lilya.datastructures import URL, Header
from lilya.encoders import ENCODER_TYPES, EncoderProtocol, MoldingProtocol, json_encode
from lilya.enums import Event, HTTPMethod, MediaType
from lilya.logging import logger
from lilya.ranges import ContentRanges, Range, parse_range_value
from lilya.serializers import serializer
from lilya.types import Message, Receive, Scope, Send

--- CROSS-IMPORTS FROM CORE MODULES ---
(None - responses.py does NOT import from routing, apps, or dependencies)

--- EXTERNAL CONSUMERS (33 matches in 28 files) ---
Files that import from lilya.responses:
1. lilya/background.py (2 imports)
2. lilya/conf/global_settings.py (3 imports)
3. lilya/authentication.py (1 import)
4. lilya/controllers.py (1 import)
5. lilya/apps.py (2 imports) *** CROSS-CONSUMER: apps imports responses ***
6. lilya/contrib/responses/json.py (1 import)
7. lilya/middleware/authentication.py (1 import)
8. lilya/contrib/responses/shortcuts.py (1 import)
9. lilya/staticfiles.py (1 import)
10. lilya/contrib/responses/files.py (1 import)
11. lilya/middleware/trustedreferrer.py (1 import)
12. lilya/middleware/httpsredirect.py (1 import)
13. lilya/middleware/lilya_exception.py (1 import)
14. lilya/middleware/trustedhost.py (1 import)
15. lilya/middleware/cors.py (1 import)
16. lilya/middleware/server_error.py (1 import)
17. lilya/_internal/_responses.py (1 import)
18. lilya/middleware/exceptions.py (1 import)
19. lilya/routing.py (1 import) *** CROSS-CONSUMER: routing imports responses ***
20. lilya/_internal/_exception_handlers.py (1 import)
21. lilya/templating/jinja.py (1 import)
22. lilya/contrib/security/csrf.py (1 import)
23. lilya/templating/controllers.py (1 import)
24. lilya/templating/base.py (1 import)
25. lilya/contrib/openapi/config.py (1 import)
26. lilya/_internal/_templates/project_template_simple/project_name/app.py-tpl (1 import)
27. lilya/contrib/openapi/docs.py (1 import)
28. lilya/contrib/security/signed_urls.py (1 import)

================================================================================
4. MODULE: lilya/dependencies.py (1022 lines)
================================================================================

--- STDLIB IMPORTS ---
from __future__ import annotations
import contextlib
import inspect
import sys
from collections.abc import Callable, Coroutine, Sequence
from functools import cached_property, lru_cache, wraps
from types import GeneratorType
from typing import Any, TypeVar, cast

--- THIRD-PARTY IMPORTS ---
(None detected in first 100 lines)

--- INTERNAL LILYA IMPORTS ---
from lilya._internal._scopes import scope_manager
from lilya.compat import is_async_callable, run_sync
from lilya.enums import Scope, SignatureDefault
from lilya.requests import Request
from lilya.websockets import WebSocket

--- CROSS-IMPORTS FROM CORE MODULES ---
(None - dependencies.py does NOT import from routing, apps, or responses)

--- EXTERNAL CONSUMERS (4 matches in 4 files) ---
Files that import from lilya.dependencies:
1. lilya/apps.py (1 import) *** CROSS-CONSUMER: apps imports dependencies ***
2. lilya/contrib/mail/dependencies.py (1 import)
3. lilya/_internal/_responses.py (1 import)
4. lilya/routing.py (1 import) *** CROSS-CONSUMER: routing imports dependencies ***

================================================================================
5. CROSS-IMPORTS ANALYSIS
================================================================================

Cross-import relationships between the 4 core modules:

routing.py IMPORTS:
  ├── dependencies.py → wrap_dependency
  └── responses.py → PlainText, RedirectResponse, Response

apps.py IMPORTS:
  ├── dependencies.py → wrap_dependency
  ├── responses.py → PlainText, Response
  └── routing.py → BasePath, Include, Path, Router, RoutingMethodsMixin

responses.py IMPORTS:
  └── (None - no cross-imports to other core modules)

dependencies.py IMPORTS:
  └── (None - no cross-imports to other core modules)

================================================================================
6. CIRCULAR IMPORT DETECTION
================================================================================

CIRCULAR IMPORT FOUND: routing.py ⇄ apps.py
  - routing.py does NOT directly import apps.py
  - apps.py IMPORTS routing.py (line 34): BasePath, Include, Path, Router, RoutingMethodsMixin
  - However, routing.py is imported BY apps.py, and apps.py is consumed BY routing-related code
  - STATUS: NO DIRECT CIRCULAR IMPORT (one-way: apps → routing)

POTENTIAL INDIRECT CIRCULAR: Check _internal/_responses.py
  - _internal/_responses.py imports BOTH routing.py and responses.py
  - routing.py imports responses.py
  - STATUS: This creates an indirect cycle through _internal

DEPENDENCY HIERARCHY (bottom to top):
  Level 1 (Foundation): dependencies.py, responses.py (no cross-imports)
  Level 2 (Routing): routing.py (imports dependencies, responses)
  Level 3 (Application): apps.py (imports routing, dependencies, responses)

NO DIRECT CIRCULAR IMPORTS DETECTED between the 4 core modules.
All imports flow upward in the dependency hierarchy.

================================================================================
7. EXTERNAL CONSUMER SUMMARY
================================================================================

Module                    External Consumers    Consumer Count
------------------------------------------------------------------------
lilya/routing.py          17 files              38 imports
lilya/apps.py             17 files              41 imports
lilya/responses.py        28 files              33 imports
lilya/dependencies.py     4 files               4 imports

Most consumed module: apps.py (41 imports, 17 files)
Least consumed module: dependencies.py (4 imports, 4 files)

Top consumers of routing.py:
  - lilya/apps.py (11 imports)
  - lilya/conf/global_settings.py (9 imports)

Top consumers of apps.py:
  - lilya/apps.py itself (16 self-imports in docstrings)
  - lilya/conf/global_settings.py (7 imports)

Top consumers of responses.py:
  - Multiple middleware files (11 middleware files import responses)
  - lilya/routing.py, lilya/apps.py (each import responses)

All consumers of dependencies.py:
  - lilya/routing.py
  - lilya/apps.py
  - lilya/_internal/_responses.py
  - lilya/contrib/mail/dependencies.py

================================================================================
8. DEPENDENCY GRAPH (ASCII)
================================================================================

                        ┌─────────────────┐
                        │   apps.py       │
                        │   (Level 3)     │
                        └────────┬────────┘
                                 │
                    ┌────────────┼────────────┐
                    │            │            │
                    ▼            ▼            ▼
          ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
          │ routing.py  │ │responses.py │ │dependencies │
          │ (Level 2)   │ │ (Level 1)   │ │   (Level 1) │
          └──────┬──────┘ └─────────────┘ └─────────────┘
                 │
        ┌────────┼────────┐
        │                 │
        ▼                 ▼
 ┌─────────────┐   ┌─────────────┐
 │responses.py │   │dependencies │
 │ (Level 1)   │   │   (Level 1) │
 └─────────────┘   └─────────────┘


Legend:
  → Direct import
  ▼ Dependency flow
  Level 1: Foundation modules (no cross-imports)
  Level 2: Routing layer (imports foundation)
  Level 3: Application layer (imports routing + foundation)

================================================================================
9. KEY FINDINGS
================================================================================

1. CLEAN DEPENDENCY HIERARCHY: Dependencies flow upward cleanly from 
   dependencies/responses → routing → apps

2. NO CIRCULAR IMPORTS: No direct circular imports detected between the 4 core modules

3. FOUNDATION MODULES: dependencies.py and responses.py are independent foundation 
   modules with no cross-imports to other core modules

4. ROUTING AS INTEGRATION LAYER: routing.py integrates dependencies and responses

5. APPS AS TOP-LEVEL: apps.py sits at the top, importing from all other core modules

6. HIGH COUPLING: routing.py (2773L) has extensive external consumers (38 imports, 17 files),
   indicating it's a critical integration point

7. LOW COUPLING: dependencies.py has minimal external consumers (4 imports, 4 files),
   suggesting it's a stable, focused module

8. MIDDLEWARE DEPENDENCY: responses.py is heavily consumed by middleware (11 middleware files),
   indicating it's a critical component for request/response handling

================================================================================
10. IMPLICATIONS FOR REFACTORING
================================================================================

For Plan 4 (routing.py decomposition):
  - routing.py imports dependencies.py and responses.py
  - Any extracted modules must maintain these import relationships
  - 17 files consume routing.py; breaking changes require widespread updates

For Plan 5 (cross-module architecture):
  - Clean upward dependency flow enables safe refactoring
  - responses.py and dependencies.py are stable foundations
  - Focus on routing.py ⇄ apps.py interface for improvements

For circular import prevention:
  - Current architecture already prevents direct circularity
  - Monitor _internal/_responses.py for indirect cycles

================================================================================
END OF IMPORT DEPENDENCY GRAPH
================================================================================
